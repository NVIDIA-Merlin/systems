<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merlin Systems &mdash; Merlin Systems  documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/mystnb.css" type="text/css" />
    <link rel="canonical" href="https://nvidia-merlin.github.io/systems/main/README.html" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Merlin Systems Example Notebook" href="examples/index.html" />
    <link rel="prev" title="Merlin Systems" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Merlin Systems
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quickstart">Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-a-four-stage-recommender-pipeline">Building a Four-Stage Recommender Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#feedback-and-support">Feedback and Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Merlin Systems</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Merlin Systems</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="tex2jax_ignore mathjax_ignore section" id="merlin-systems">
<h1><a class="reference external" href="https://github.com/NVIDIA-Merlin/systems">Merlin Systems</a><a class="headerlink" href="#merlin-systems" title="Permalink to this headline"></a></h1>
<p><img alt="PyPI - Python Version" src="https://img.shields.io/pypi/pyversions/merlin-systems" />
<a class="reference external" href="https://pypi.python.org/pypi/merlin-systems/"><img alt="PyPI version shields.io" src="https://img.shields.io/pypi/v/merlin-systems.svg" /></a>
<img alt="GitHub License" src="https://img.shields.io/github/license/NVIDIA-Merlin/systems" />
<a class="reference external" href="https://nvidia-merlin.github.io/systems/main/README.html"><img alt="Documentation" src="https://img.shields.io/badge/documentation-blue.svg" /></a></p>
<p>Merlin Systems provides tools for combining recommendation models with other elements of production recommender systems like feature stores, nearest neighbor search, and exploration strategies into end-to-end recommendation pipelines that can be served with <a class="reference external" href="https://github.com/triton-inference-server/server">Triton Inference Server</a>.</p>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline"></a></h2>
<p>Merlin Systems uses the Merlin Operator DAG API, the same API used in <a class="reference external" href="https://github.com/NVIDIA-Merlin/NVTabular">NVTabular</a> for feature engineering, to create serving ensembles. To combine a feature engineering workflow and a Tensorflow model into an inference pipeline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">nvtabular.workflow</span> <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag</span> <span class="kn">import</span> <span class="n">Ensemble</span><span class="p">,</span> <span class="n">PredictTensorflow</span><span class="p">,</span> <span class="n">TransformWorkflow</span>

<span class="c1"># Load saved NVTabular workflow and TensorFlow model</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nvtabular_workflow_path</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">tf_model_path</span><span class="p">)</span>

<span class="c1"># Remove target/label columns from feature processing workflowk</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">remove_inputs</span><span class="p">([</span><span class="o">&lt;</span><span class="n">target_columns</span><span class="o">&gt;</span><span class="p">])</span>

<span class="c1"># Define ensemble pipeline</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="p">(</span>
	<span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span> <span class="o">&gt;&gt;</span>
	<span class="n">TransformWorkflow</span><span class="p">(</span><span class="n">workflow</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	<span class="n">PredictTensorflow</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Export artifacts to disk</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">Ensemble</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="p">)</span>
<span class="n">ensemble</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">export_path</span><span class="p">)</span>
</pre></div>
</div>
<p>After you export your ensemble, you reference the directory to run an instance of Triton Inference Server to host your ensemble.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>tritonserver --model-repository<span class="o">=</span>/export_path/
</pre></div>
</div>
<p>Refer to the <a class="reference internal" href="examples/index.html"><span class="xref myst">Merlin Systems Example Notebooks</span></a> for a notebook that serves a ranking models ensemble.
The notebook shows how to deploy the ensemble and demonstrates sending requests to Triton Inference Server.</p>
</div>
<div class="section" id="building-a-four-stage-recommender-pipeline">
<h2>Building a Four-Stage Recommender Pipeline<a class="headerlink" href="#building-a-four-stage-recommender-pipeline" title="Permalink to this headline"></a></h2>
<p>Merlin Systems can also build more complex serving pipelines that integrate multiple models and external tools (like feature stores and nearest neighbor search):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load artifacts for the pipeline</span>
<span class="n">retrieval_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">retrieval_model_path</span><span class="p">)</span>
<span class="n">ranking_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">ranking_model_path</span><span class="p">)</span>
<span class="n">feature_store</span> <span class="o">=</span> <span class="n">feast</span><span class="o">.</span><span class="n">FeatureStore</span><span class="p">(</span><span class="n">feast_repo_path</span><span class="p">)</span>

<span class="c1"># Define the fields expected in requests</span>
<span class="n">request_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">([</span>
    <span class="n">ColumnSchema</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># Fetch user features, use them to a compute user vector with retrieval model,</span>
<span class="c1"># and find candidate items closest to the user vector with nearest neighbor search</span>
<span class="n">user_features</span> <span class="o">=</span> <span class="n">request_schema</span><span class="o">.</span><span class="n">column_names</span> <span class="o">&gt;&gt;</span> <span class="n">QueryFeast</span><span class="o">.</span><span class="n">from_feature_view</span><span class="p">(</span>
    <span class="n">store</span><span class="o">=</span><span class="n">feature_store</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s2">&quot;user_features&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span>
<span class="p">)</span>

<span class="n">retrieval</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">user_features</span>
    <span class="o">&gt;&gt;</span> <span class="n">PredictTensorflow</span><span class="p">(</span><span class="n">retrieval_model_path</span><span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">QueryFaiss</span><span class="p">(</span><span class="n">faiss_index_path</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Filter out candidate items that have already interacted with</span>
<span class="c1"># in the current session and fetch item features for the rest</span>
<span class="n">filtering</span> <span class="o">=</span> <span class="n">retrieval</span><span class="p">[</span><span class="s2">&quot;candidate_ids&quot;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">FilterCandidates</span><span class="p">(</span>
    <span class="n">filter_out</span><span class="o">=</span><span class="n">user_features</span><span class="p">[</span><span class="s2">&quot;movie_ids&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">item_features</span> <span class="o">=</span> <span class="n">filtering</span> <span class="o">&gt;&gt;</span> <span class="n">QueryFeast</span><span class="o">.</span><span class="n">from_feature_view</span><span class="p">(</span>
    <span class="n">store</span><span class="o">=</span><span class="n">feature_store</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s2">&quot;movie_features&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;filtered_ids&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Join user and item features for the candidates and use them to predict relevance scores</span>
<span class="n">combined_features</span> <span class="o">=</span> <span class="n">item_features</span> <span class="o">&gt;&gt;</span> <span class="n">UnrollFeatures</span><span class="p">(</span>
    <span class="s2">&quot;movie_id&quot;</span><span class="p">,</span> <span class="n">user_features</span><span class="p">,</span> <span class="n">unrolled_prefix</span><span class="o">=</span><span class="s2">&quot;user&quot;</span>
<span class="p">)</span>

<span class="n">ranking</span> <span class="o">=</span> <span class="n">combined_features</span> <span class="o">&gt;&gt;</span> <span class="n">PredictTensorflow</span><span class="p">(</span><span class="n">ranking_model_path</span><span class="p">)</span>

<span class="c1"># Sort candidate items by relevance score with some randomized exploration</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="n">combined_features</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">SoftmaxSampling</span><span class="p">(</span>
    <span class="n">relevance_col</span><span class="o">=</span><span class="n">ranking</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span> <span class="n">topk</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">20.0</span>
<span class="p">)</span>

<span class="c1"># Create and export the ensemble</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">Ensemble</span><span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">request_schema</span><span class="p">)</span>
<span class="n">ensemble</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;./ensemble&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h2>
<p>Merlin Systems requires Triton Inference Server and Tensorflow. The simplest setup is to use the <a class="reference external" href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/merlin/containers/merlin-tensorflow-inference">Merlin Tensorflow Inference Docker container</a>, which has both pre-installed.</p>
<div class="section" id="installing-merlin-systems-using-pip">
<h3>Installing Merlin Systems Using Pip<a class="headerlink" href="#installing-merlin-systems-using-pip" title="Permalink to this headline"></a></h3>
<p>You can install Merlin Systems with <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install merlin-systems
</pre></div>
</div>
</div>
<div class="section" id="installing-merlin-systems-from-source">
<h3>Installing Merlin Systems from Source<a class="headerlink" href="#installing-merlin-systems-from-source" title="Permalink to this headline"></a></h3>
<p>Merlin Systems can be installed from source by cloning the GitHub repository and running <code class="docutils literal notranslate"><span class="pre">setup.py</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/NVIDIA-Merlin/systems.git
<span class="nb">cd</span> systems <span class="o">&amp;&amp;</span> python setup.py develop
</pre></div>
</div>
</div>
<div class="section" id="running-merlin-systems-from-docker">
<h3>Running Merlin Systems from Docker<a class="headerlink" href="#running-merlin-systems-from-docker" title="Permalink to this headline"></a></h3>
<p>Merlin Systems is installed on multiple Docker containers that are available from the NVIDIA GPU Cloud (NGC) catalog.
The following table lists the containers that include Triton Inference Server for use with Merlin.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Container Name</p></th>
<th class="head"><p>Container Location</p></th>
<th class="head"><p>Functionality</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">merlin-hugectr</span></code></p></td>
<td><p><a class="reference external" href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/merlin/containers/merlin-hugectr">https://catalog.ngc.nvidia.com/orgs/nvidia/teams/merlin/containers/merlin-hugectr</a></p></td>
<td><p>Merlin frameworks, HugeCTR, and Triton Inference Server</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">merlin-tensorflow</span></code></p></td>
<td><p><a class="reference external" href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/merlin/containers/merlin-tensorflow">https://catalog.ngc.nvidia.com/orgs/nvidia/teams/merlin/containers/merlin-tensorflow</a></p></td>
<td><p>Merlin frameworks selected for only Tensorflow support and Triton Inference Server</p></td>
</tr>
</tbody>
</table>
<p>If you want to add support for GPU-accelerated workflows, you will first need to install the <a class="reference external" href="https://github.com/NVIDIA/nvidia-docker">NVIDIA Container Toolkit</a> to provide GPU support for Docker. You can use the NGC links referenced in the table above to obtain more information about how to launch and run these containers.</p>
</div>
</div>
<div class="section" id="feedback-and-support">
<h2>Feedback and Support<a class="headerlink" href="#feedback-and-support" title="Permalink to this headline"></a></h2>
<p>To report bugs or get help, please <a class="reference external" href="https://github.com/NVIDIA-Merlin/NVTabular/issues/new/choose">open an issue</a>.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Merlin Systems" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="examples/index.html" class="btn btn-neutral float-right" title="Merlin Systems Example Notebook" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: main
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../v0.2.0/index.html">v0.2.0</a></dd>
      <dd><a href="../v0.3.0/index.html">v0.3.0</a></dd>
      <dd><a href="../v0.4.0/index.html">v0.4.0</a></dd>
      <dd><a href="../v0.5.0/index.html">v0.5.0</a></dd>
      <dd><a href="../v0.6.0/index.html">v0.6.0</a></dd>
      <dd><a href="../v0.7.0/index.html">v0.7.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="README.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVJ1Y1YJHK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NVJ1Y1YJHK', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>