<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>merlin.systems.triton.export &mdash; Merlin Systems  documentation</title><link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Merlin Systems
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/README.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Merlin Systems</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>merlin.systems.triton.export</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for merlin.systems.triton.export</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2022, NVIDIA CORPORATION.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span><span class="p">,</span> <span class="n">copytree</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># this needs to be before any modules that import protobuf</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>

<span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="kn">import</span> <span class="n">text_format</span>  <span class="c1"># noqa</span>

<span class="kn">import</span> <span class="nn">merlin.systems.triton.model_config_pb2</span> <span class="k">as</span> <span class="nn">model_config</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">merlin.core.dispatch</span> <span class="kn">import</span> <span class="n">is_string_dtype</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">merlin.dag</span> <span class="kn">import</span> <span class="n">ColumnSelector</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">merlin.schema</span> <span class="kn">import</span> <span class="n">Tags</span>  <span class="c1"># noqa</span>


<div class="viewcode-block" id="export_tensorflow_ensemble"><a class="viewcode-back" href="../../../../generated/merlin.systems.triton.export_tensorflow_ensemble.html#merlin.systems.triton.export_tensorflow_ensemble">[docs]</a><span class="k">def</span> <span class="nf">export_tensorflow_ensemble</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">workflow</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sparse_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">nvtabular_backend</span><span class="o">=</span><span class="s2">&quot;nvtabular&quot;</span><span class="p">,</span>
    <span class="n">cats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an ensemble triton server model, with the first model being a nvtabular</span>
<span class="sd">    preprocessing, and the second by a tensorflow savedmodel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model:</span>
<span class="sd">        The tensorflow model that should be served</span>
<span class="sd">    workflow:</span>
<span class="sd">        The nvtabular workflow used in preprocessing</span>
<span class="sd">    name:</span>
<span class="sd">        The base name of the various triton models</span>
<span class="sd">    model_path:</span>
<span class="sd">        The root path to write out files to</span>
<span class="sd">    cats:</span>
<span class="sd">        Names of the categorical columns</span>
<span class="sd">    conts:</span>
<span class="sd">        Names of the continuous columns</span>
<span class="sd">    label_columns:</span>
<span class="sd">        Labels in the dataset (will be removed from the dataset)</span>
<span class="sd">    sparse_max:</span>
<span class="sd">        Max length of the each row when the sparse data is converted to dense</span>
<span class="sd">    version:</span>
<span class="sd">        Version of the model</span>
<span class="sd">    nvtabular_backend: &quot;python&quot; or &quot;nvtabular&quot;</span>
<span class="sd">        The backend that will be used for inference in Triton.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">label_columns</span>
        <span class="ow">or</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ColumnSelector</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">Tags</span><span class="o">.</span><span class="n">TARGET</span><span class="p">]))</span><span class="o">.</span><span class="n">column_names</span>
    <span class="p">)</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">remove_inputs</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># generate the TF saved model</span>
    <span class="n">tf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_tf&quot;</span><span class="p">)</span>
    <span class="n">tf_config</span> <span class="o">=</span> <span class="n">export_tensorflow_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_tf&quot;</span><span class="p">,</span> <span class="n">tf_path</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>

    <span class="c1"># override the output dtype of the nvtabular model if necessary (fixes mismatches</span>
    <span class="c1"># in dtypes between tf inputs and nvt outputs)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">tf_config</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="n">tf_dtype</span> <span class="o">=</span> <span class="n">_triton_datatype_to_dtype</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">nvt_col_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__values&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__nnzs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">col_schema</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="p">[</span><span class="n">nvt_col_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">col_schema</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">and</span> <span class="n">col_schema</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">tf_dtype</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;TF model expects </span><span class="si">{</span><span class="n">tf_dtype</span><span class="si">}</span><span class="s2"> for column </span><span class="si">{</span><span class="n">col_schema</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, but workflow &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; is producing type </span><span class="si">{</span><span class="n">col_schema</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">. Overriding dtype in NVTabular workflow.&quot;</span>
            <span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_schemas</span><span class="p">[</span><span class="n">col_schema</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_schema</span><span class="o">.</span><span class="n">with_dtype</span><span class="p">(</span><span class="n">tf_dtype</span><span class="p">)</span>

    <span class="c1"># generate the nvtabular triton model</span>
    <span class="n">preprocessing_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span><span class="p">)</span>
    <span class="n">nvt_config</span> <span class="o">=</span> <span class="n">generate_nvtabular_model</span><span class="p">(</span>
        <span class="n">workflow</span><span class="p">,</span>
        <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span><span class="p">,</span>
        <span class="n">preprocessing_path</span><span class="p">,</span>
        <span class="n">sparse_max</span><span class="o">=</span><span class="n">sparse_max</span><span class="p">,</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">nvtabular_backend</span><span class="p">,</span>
        <span class="n">cats</span><span class="o">=</span><span class="n">cats</span><span class="p">,</span>
        <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># generate the triton ensemble</span>
    <span class="n">ensemble_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ensemble_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ensemble_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_generate_ensemble_config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ensemble_path</span><span class="p">,</span> <span class="n">nvt_config</span><span class="p">,</span> <span class="n">tf_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="export_pytorch_ensemble"><a class="viewcode-back" href="../../../../generated/merlin.systems.triton.export_pytorch_ensemble.html#merlin.systems.triton.export_pytorch_ensemble">[docs]</a><span class="k">def</span> <span class="nf">export_pytorch_ensemble</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">workflow</span><span class="p">,</span>
    <span class="n">sparse_max</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">model_path</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_fix_dtypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">nvtabular_backend</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="n">cats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an ensemble triton server model, with the first model being a nvtabular</span>
<span class="sd">    preprocessing, and the second by a pytorch savedmodel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model:</span>
<span class="sd">        The pytorch model that should be served</span>
<span class="sd">    workflow:</span>
<span class="sd">        The nvtabular workflow used in preprocessing</span>
<span class="sd">    sparse_max:</span>
<span class="sd">        Max length of the each row when the sparse data is converted to dense</span>
<span class="sd">    name:</span>
<span class="sd">        The base name of the various triton models</span>
<span class="sd">    model_path:</span>
<span class="sd">        The root path to write out files to</span>
<span class="sd">    cats:</span>
<span class="sd">        Names of the categorical columns</span>
<span class="sd">    conts:</span>
<span class="sd">        Names of the continuous columns</span>
<span class="sd">    label_columns:</span>
<span class="sd">        Labels in the dataset (will be removed from the dataset)</span>
<span class="sd">    use_fix_dtypes:</span>
<span class="sd">        Transformers4Rec is using fixed dtypes and this option is</span>
<span class="sd">        whether to use fixed dtypes in inference or not</span>
<span class="sd">    version:</span>
<span class="sd">        Version of the model</span>
<span class="sd">    nvtabular_backend: &quot;python&quot; or &quot;nvtabular&quot;</span>
<span class="sd">        The backend that will be used for inference in Triton.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">label_columns</span>
        <span class="ow">or</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ColumnSelector</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">Tags</span><span class="o">.</span><span class="n">TARGET</span><span class="p">]))</span><span class="o">.</span><span class="n">column_names</span>
    <span class="p">)</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">remove_inputs</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># generate the TF saved model</span>
    <span class="n">pt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_pt&quot;</span><span class="p">)</span>
    <span class="n">pt_config</span> <span class="o">=</span> <span class="n">export_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">sparse_max</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_pt&quot;</span><span class="p">,</span> <span class="n">pt_path</span><span class="p">,</span> <span class="n">use_fix_dtypes</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span>
    <span class="p">)</span>

    <span class="c1"># override the output dtype of the nvtabular model if necessary (fixes mismatches</span>
    <span class="c1"># in dtypes between tf inputs and nvt outputs)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">pt_config</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="n">pt_dtype</span> <span class="o">=</span> <span class="n">_triton_datatype_to_dtype</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">nvt_dtype</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_dtypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nvt_dtype</span> <span class="ow">and</span> <span class="n">nvt_dtype</span> <span class="o">!=</span> <span class="n">pt_dtype</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;PyTorch model expects </span><span class="si">{</span><span class="n">pt_dtype</span><span class="si">}</span><span class="s2"> for column </span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, but workflow &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; is producing type </span><span class="si">{</span><span class="n">nvt_dtype</span><span class="si">}</span><span class="s2">. Overriding dtype in NVTabular workflow.&quot;</span>
            <span class="p">)</span>
            <span class="n">workflow</span><span class="o">.</span><span class="n">output_dtypes</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_dtype</span>

    <span class="c1"># generate the nvtabular triton model</span>
    <span class="n">preprocessing_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span><span class="p">)</span>
    <span class="n">nvt_config</span> <span class="o">=</span> <span class="n">generate_nvtabular_model</span><span class="p">(</span>
        <span class="n">workflow</span><span class="p">,</span>
        <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span><span class="p">,</span>
        <span class="n">preprocessing_path</span><span class="p">,</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">nvtabular_backend</span><span class="p">,</span>
        <span class="n">cats</span><span class="o">=</span><span class="n">cats</span><span class="p">,</span>
        <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># generate the triton ensemble</span>
    <span class="n">ensemble_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ensemble_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ensemble_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_generate_ensemble_config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ensemble_path</span><span class="p">,</span> <span class="n">nvt_config</span><span class="p">,</span> <span class="n">pt_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="export_hugectr_ensemble"><a class="viewcode-back" href="../../../../generated/merlin.systems.triton.export_hugectr_ensemble.html#merlin.systems.triton.export_hugectr_ensemble">[docs]</a><span class="k">def</span> <span class="nf">export_hugectr_ensemble</span><span class="p">(</span>
    <span class="n">workflow</span><span class="p">,</span>
    <span class="n">hugectr_model_path</span><span class="p">,</span>
    <span class="n">hugectr_params</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nvtabular_backend</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="n">cats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an ensemble hugectr server model, with the first model being a nvtabular</span>
<span class="sd">    preprocessing, and the second by a hugectr savedmodel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    workflow:</span>
<span class="sd">        The nvtabular workflow used in preprocessing</span>
<span class="sd">    hugectr_model_path:</span>
<span class="sd">        The path of the trained model files</span>
<span class="sd">    hugectr_params:</span>
<span class="sd">        HugeCTR specific parameters</span>
<span class="sd">    name:</span>
<span class="sd">        The base name of the various triton models</span>
<span class="sd">    output_path:</span>
<span class="sd">        The path where the models will be served</span>
<span class="sd">    version:</span>
<span class="sd">        The version of the model</span>
<span class="sd">    max_batch_size:</span>
<span class="sd">        Max batch size that Triton can receive</span>
<span class="sd">    nvtabular_backend: &quot;python&quot; or &quot;nvtabular&quot;</span>
<span class="sd">        The backend that will be used for inference in Triton.</span>
<span class="sd">    cats:</span>
<span class="sd">        Names of the categorical columns</span>
<span class="sd">    conts:</span>
<span class="sd">        Names of the continuous columns</span>
<span class="sd">    label_columns:</span>
<span class="sd">        Labels in the dataset (will be removed from the dataset)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cats</span> <span class="o">=</span> <span class="n">cats</span> <span class="ow">or</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ColumnSelector</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">Tags</span><span class="o">.</span><span class="n">CATEGORICAL</span><span class="p">]))</span>
    <span class="n">conts</span> <span class="o">=</span> <span class="n">conts</span> <span class="ow">or</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ColumnSelector</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">Tags</span><span class="o">.</span><span class="n">CONTINUOUS</span><span class="p">]))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">label_columns</span> <span class="ow">or</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ColumnSelector</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">Tags</span><span class="o">.</span><span class="n">TARGET</span><span class="p">]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">conts</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either cats or conts has to have a value.&quot;</span><span class="p">)</span>

    <span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">remove_inputs</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="c1"># generate the nvtabular triton model</span>
    <span class="n">preprocessing_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span><span class="p">)</span>
    <span class="n">nvt_config</span> <span class="o">=</span> <span class="n">generate_nvtabular_model</span><span class="p">(</span>
        <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">preprocessing_path</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
        <span class="n">output_model</span><span class="o">=</span><span class="s2">&quot;hugectr&quot;</span><span class="p">,</span>
        <span class="n">max_batch_size</span><span class="o">=</span><span class="n">max_batch_size</span><span class="p">,</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">nvtabular_backend</span><span class="p">,</span>
        <span class="n">cats</span><span class="o">=</span><span class="n">cats</span><span class="p">,</span>
        <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;label_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;des_feature_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;des_feature_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">conts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;cat_feature_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;cat_feature_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cats</span><span class="p">)</span>

    <span class="c1"># generate the HugeCTR saved model</span>
    <span class="n">hugectr_config</span> <span class="o">=</span> <span class="n">generate_hugectr_model</span><span class="p">(</span>
        <span class="n">trained_model_path</span><span class="o">=</span><span class="n">hugectr_model_path</span><span class="p">,</span>
        <span class="n">hugectr_params</span><span class="o">=</span><span class="n">hugectr_params</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
        <span class="n">max_batch_size</span><span class="o">=</span><span class="n">max_batch_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># generate the triton ensemble</span>
    <span class="n">ensemble_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_ens&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ensemble_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ensemble_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_generate_ensemble_config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ensemble_path</span><span class="p">,</span> <span class="n">nvt_config</span><span class="p">,</span> <span class="n">hugectr_config</span><span class="p">,</span> <span class="s2">&quot;_ens&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_generate_ensemble_config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">nvt_config</span><span class="p">,</span> <span class="n">nn_config</span><span class="p">,</span> <span class="n">name_ext</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="n">name_ext</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;ensemble&quot;</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="n">nvt_config</span><span class="o">.</span><span class="n">max_batch_size</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nvt_config</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nn_config</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

    <span class="n">nn_input_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">nn_config</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

    <span class="n">nvt_step</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelEnsembling</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">nvt_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model_version</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">input_col</span> <span class="ow">in</span> <span class="n">nvt_config</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="n">nvt_step</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span><span class="n">input_col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_col</span><span class="o">.</span><span class="n">name</span>
    <span class="k">for</span> <span class="n">output_col</span> <span class="ow">in</span> <span class="n">nvt_config</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_col</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nn_input_cols</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Column </span><span class="si">{</span><span class="n">output_col</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is being generated by NVTabular workflow &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; but is unused in </span><span class="si">{</span><span class="n">nn_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> model&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">nvt_step</span><span class="o">.</span><span class="n">output_map</span><span class="p">[</span><span class="n">output_col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_col</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span>

    <span class="n">tf_step</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelEnsembling</span><span class="o">.</span><span class="n">Step</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">nn_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model_version</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">input_col</span> <span class="ow">in</span> <span class="n">nn_config</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="n">tf_step</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span><span class="n">input_col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_col</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_nvt&quot;</span>
    <span class="k">for</span> <span class="n">output_col</span> <span class="ow">in</span> <span class="n">nn_config</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="n">tf_step</span><span class="o">.</span><span class="n">output_map</span><span class="p">[</span><span class="n">output_col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_col</span><span class="o">.</span><span class="n">name</span>

    <span class="n">config</span><span class="o">.</span><span class="n">ensemble_scheduling</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nvt_step</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">ensemble_scheduling</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf_step</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">text_format</span><span class="o">.</span><span class="n">PrintMessage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<div class="viewcode-block" id="generate_nvtabular_model"><a class="viewcode-back" href="../../../../generated/merlin.systems.triton.generate_nvtabular_model.html#merlin.systems.triton.generate_nvtabular_model">[docs]</a><span class="k">def</span> <span class="nf">generate_nvtabular_model</span><span class="p">(</span>
    <span class="n">workflow</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">output_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sparse_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="n">cats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;converts a workflow to a triton mode</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sparse_max:</span>
<span class="sd">        Max length of the each row when the sparse data is converted to dense</span>
<span class="sd">    cats:</span>
<span class="sd">        Names of the categorical columns</span>
<span class="sd">    conts:</span>
<span class="sd">        Names of the continuous columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;workflow&quot;</span><span class="p">))</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_generate_nvtabular_config</span><span class="p">(</span>
        <span class="n">workflow</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">,</span>
        <span class="n">output_model</span><span class="p">,</span>
        <span class="n">max_batch_size</span><span class="p">,</span>
        <span class="n">sparse_max</span><span class="o">=</span><span class="n">sparse_max</span><span class="p">,</span>
        <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
        <span class="n">cats</span><span class="o">=</span><span class="n">cats</span><span class="p">,</span>
        <span class="n">conts</span><span class="o">=</span><span class="n">conts</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># copy the model file over. note that this isn&#39;t necessary with the c++ backend, but</span>
    <span class="c1"># does provide us to use the python backend with just changing the &#39;backend&#39; parameter</span>
    <span class="n">copyfile</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;workflow_model.py&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;model.py&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="generate_hugectr_model"><a class="viewcode-back" href="../../../../generated/merlin.systems.triton.generate_hugectr_model.html#merlin.systems.triton.generate_hugectr_model">[docs]</a><span class="k">def</span> <span class="nf">generate_hugectr_model</span><span class="p">(</span>
    <span class="n">trained_model_path</span><span class="p">,</span>
    <span class="n">hugectr_params</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;converts a trained HugeCTR model to a triton mode&quot;&quot;&quot;</span>

    <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">out_path_version</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_path_version</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">_generate_hugectr_config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">hugectr_params</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="n">max_batch_size</span><span class="p">)</span>
    <span class="n">copytree</span><span class="p">(</span><span class="n">trained_model_path</span><span class="p">,</span> <span class="n">out_path_version</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span></div>


<span class="k">def</span> <span class="nf">_generate_nvtabular_config</span><span class="p">(</span>
    <span class="n">workflow</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">,</span>
    <span class="n">output_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">max_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sparse_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="n">cats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;given a workflow generates the trton modelconfig proto object describing the inputs</span>
<span class="sd">    and outputs to that workflow&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="n">max_batch_size</span><span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;python_module&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="s2">&quot;merlin.systems.triton.workflow_model&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;output_model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="n">output_model</span> <span class="k">if</span> <span class="n">output_model</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;cats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cats</span><span class="p">)</span> <span class="k">if</span> <span class="n">cats</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;conts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">conts</span><span class="p">)</span> <span class="k">if</span> <span class="n">conts</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sparse_max</span><span class="p">:</span>
        <span class="c1"># this assumes seq_length is same for each list column</span>
        <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;sparse_max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sparse_max</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_model</span> <span class="o">==</span> <span class="s2">&quot;hugectr&quot;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">instance_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">ModelInstanceGroup</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_node</span><span class="o">.</span><span class="n">input_columns</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">input_dtypes</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;DES&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP32</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CATCOLUMN&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT64</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ROWINDEX&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT32</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">output_model</span> <span class="o">==</span> <span class="s2">&quot;pytorch&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_schema</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_add_model_param</span><span class="p">(</span><span class="n">col_schema</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_schema</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_add_model_param</span><span class="p">(</span>
                <span class="n">col_schema</span><span class="p">,</span>
                <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span>
                <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_schema</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_add_model_param</span><span class="p">(</span><span class="n">col_schema</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_schema</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sparse_max</span> <span class="ow">and</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">sparse_max</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># this assumes max_sequence_length is equal for all output columns</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="n">sparse_max</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                <span class="n">_add_model_param</span><span class="p">(</span><span class="n">col_schema</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_add_model_param</span><span class="p">(</span><span class="n">col_schema</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">text_format</span><span class="o">.</span><span class="n">PrintMessage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">export_tensorflow_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exports a TensorFlow model for serving with Triton</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model:</span>
<span class="sd">        The tensorflow model that should be served</span>
<span class="sd">    name:</span>
<span class="sd">        The name of the triton model to export</span>
<span class="sd">    output_path:</span>
<span class="sd">        The path to write the exported model to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tf_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;model.savedmodel&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tf_model_path</span><span class="p">,</span> <span class="n">include_optimizer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;tensorflow_savedmodel&quot;</span>
    <span class="p">)</span>

    <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">outputs</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">signatures</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;signatures&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">default_signature</span> <span class="o">=</span> <span class="n">signatures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serving_default&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">default_signature</span><span class="p">:</span>
            <span class="c1"># roundtrip saved model to disk to generate signature if it doesn&#39;t exist</span>
            <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

            <span class="n">reloaded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">tf_model_path</span><span class="p">)</span>
            <span class="n">default_signature</span> <span class="o">=</span> <span class="n">reloaded</span><span class="o">.</span><span class="n">signatures</span><span class="p">[</span><span class="s2">&quot;serving_default&quot;</span><span class="p">]</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">default_signature</span><span class="o">.</span><span class="n">structured_input_signature</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">default_signature</span><span class="o">.</span><span class="n">structured_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;TF_GRAPH_TAG&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="s2">&quot;serve&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;TF_SIGNATURE_DEF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="s2">&quot;serving_default&quot;</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="c1"># this assumes the list columns are 1D tensors both for cats and conts</span>
        <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">text_format</span><span class="o">.</span><span class="n">PrintMessage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">export_pytorch_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">sparse_max</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">use_fix_dtypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exports a PyTorch model for serving with Triton</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model:</span>
<span class="sd">        The PyTorch model that should be served</span>
<span class="sd">    workflow:</span>
<span class="sd">        The nvtabular workflow used in preprocessing</span>
<span class="sd">    sparse_max:</span>
<span class="sd">        Max length of the each row when the sparse data is converted to dense</span>
<span class="sd">    name:</span>
<span class="sd">        The name of the triton model to export</span>
<span class="sd">    output_path:</span>
<span class="sd">        The path to write the exported model to</span>
<span class="sd">    use_fix_dtypes:</span>
<span class="sd">        Transformers4Rec is using fixed dtypes and this option is</span>
<span class="sd">        whether to use fixed dtypes in inference or not</span>
<span class="sd">    version:</span>
<span class="sd">        Version of the model</span>
<span class="sd">    backend: &quot;python&quot; or &quot;nvtabular&quot;</span>
<span class="sd">        The backend that will be used for inference in Triton.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cloudpickle</span>
    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pt_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;model.pth&quot;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">pt_model_path</span><span class="p">)</span>

    <span class="n">pt_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;model.pkl&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pt_model_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">cloudpickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>

    <span class="n">copyfile</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;model_pt.py&quot;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;model.py&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">col_schema</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_schemas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_add_model_param</span><span class="p">(</span><span class="n">col_schema</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

    <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">last_layer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">last_layer</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">last_layer</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_pytorch_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">sparse_max</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s2">&quot;model_info.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">model_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">model_info</span><span class="p">[</span><span class="s2">&quot;sparse_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse_max</span>
            <span class="n">model_info</span><span class="p">[</span><span class="s2">&quot;use_fix_dtypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_fix_dtypes</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">text_format</span><span class="o">.</span><span class="n">PrintMessage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">_generate_pytorch_config</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;given a workflow generates the trton modelconfig proto object describing the inputs</span>
<span class="sd">    and outputs to that workflow&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="n">max_batch_size</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">text_format</span><span class="o">.</span><span class="n">PrintMessage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">_generate_hugectr_config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">hugectr_params</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;hugectr&quot;</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="n">max_batch_size</span><span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;DES&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP32</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;CATCOLUMN&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT64</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">model_config</span><span class="o">.</span><span class="n">ModelInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ROWINDEX&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT32</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;n_outputs&quot;</span><span class="p">]):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">model_config</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;OUTPUT&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP32</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">instance_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">ModelInstanceGroup</span><span class="p">(</span><span class="n">gpus</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">config_hugectr</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">])</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">config_hugectr</span><span class="p">)</span>

    <span class="n">gpucache_val</span> <span class="o">=</span> <span class="n">hugectr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gpucache&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>

    <span class="n">gpucache</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="n">gpucache_val</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;gpucache&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">gpucache</span><span class="p">)</span>

    <span class="n">gpucacheper_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gpucacheper_val&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5&quot;</span><span class="p">))</span>

    <span class="n">gpucacheper</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="n">gpucacheper_val</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;gpucacheper&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">gpucacheper</span><span class="p">)</span>

    <span class="n">label_dim</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;label_dim&quot;</span><span class="p">]))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;label_dim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">label_dim</span><span class="p">)</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;slots&quot;</span><span class="p">]))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;slots&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span>

    <span class="n">des_feature_num</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span>
        <span class="n">string_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;des_feature_num&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;des_feature_num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">des_feature_num</span><span class="p">)</span>

    <span class="n">cat_feature_num</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span>
        <span class="n">string_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;cat_feature_num&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;cat_feature_num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">cat_feature_num</span><span class="p">)</span>

    <span class="n">max_nnz</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;max_nnz&quot;</span><span class="p">]))</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;max_nnz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">max_nnz</span><span class="p">)</span>

    <span class="n">embedding_vector_size</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span>
        <span class="n">string_value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hugectr_params</span><span class="p">[</span><span class="s2">&quot;embedding_vector_size&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;embedding_vector_size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">embedding_vector_size</span><span class="p">)</span>

    <span class="n">embeddingkey_long_type_val</span> <span class="o">=</span> <span class="n">hugectr_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;embeddingkey_long_type&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>

    <span class="n">embeddingkey_long_type</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">(</span><span class="n">string_value</span><span class="o">=</span><span class="n">embeddingkey_long_type_val</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;embeddingkey_long_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">embeddingkey_long_type</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;config.pbtxt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">text_format</span><span class="o">.</span><span class="n">PrintMessage</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">_add_model_param</span><span class="p">(</span><span class="n">col_schema</span><span class="p">,</span> <span class="n">paramclass</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span> <span class="k">if</span> <span class="n">dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">col_schema</span><span class="o">.</span><span class="n">is_list</span> <span class="ow">and</span> <span class="n">col_schema</span><span class="o">.</span><span class="n">is_ragged</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">paramclass</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">col_schema</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;__values&quot;</span><span class="p">,</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">col_schema</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">paramclass</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">col_schema</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;__nnzs&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT64</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">paramclass</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">col_schema</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">_convert_dtype</span><span class="p">(</span><span class="n">col_schema</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_convert_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;converts a dtype to the appropriate triton proto type&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">dtype_name</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">dtype</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dtype_name</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;float64&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP64</span><span class="p">,</span>
        <span class="s2">&quot;float32&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP32</span><span class="p">,</span>
        <span class="s2">&quot;float16&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP16</span><span class="p">,</span>
        <span class="s2">&quot;int64&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT64</span><span class="p">,</span>
        <span class="s2">&quot;int32&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT32</span><span class="p">,</span>
        <span class="s2">&quot;int16&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT16</span><span class="p">,</span>
        <span class="s2">&quot;int8&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT8</span><span class="p">,</span>
        <span class="s2">&quot;uint64&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_UINT64</span><span class="p">,</span>
        <span class="s2">&quot;uint32&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_UINT32</span><span class="p">,</span>
        <span class="s2">&quot;uint16&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_UINT16</span><span class="p">,</span>
        <span class="s2">&quot;uint8&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_UINT8</span><span class="p">,</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_BOOL</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">is_string_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_STRING</span>
    <span class="k">elif</span> <span class="n">dtype_name</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">dtype_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t convert </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> to a Triton dtype&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_convert_pytorch_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;converts a dtype to the appropriate triton proto type&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP64</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP32</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_FP16</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT64</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT32</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT16</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">int8</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_INT8</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_UINT8</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_BOOL</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">is_string_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_STRING</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t convert dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_convert_string2pytorch_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;converts a dtype to the appropriate torch type&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">dtype_name</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dtype_name</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;TYPE_FP64&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_FP32&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_FP16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_INT64&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_INT32&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_INT16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_INT8&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_UINT8&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="s2">&quot;TYPE_BOOL&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">is_string_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model_config</span><span class="o">.</span><span class="n">TYPE_STRING</span>
    <span class="k">elif</span> <span class="n">dtype_name</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">dtype_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t convert dtype </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_triton_datatype_to_dtype</span><span class="p">(</span><span class="n">data_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;the reverse of _convert_dtype: converts a triton proto data_type to a numpy dtype&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">_DATATYPE</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;fp&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">))</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>