<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Serving Ranking Models With Merlin Systems &mdash; Merlin Systems  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Documentation" href="../api.html" />
    <link rel="prev" title="Merlin Systems Example Notebook" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Merlin Systems
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../README.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#running-the-example-notebook">Running the Example Notebook</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Serving Ranking Models With Merlin Systems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Merlin Systems</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Merlin Systems Example Notebook</a> &raquo;</li>
      <li>Serving Ranking Models With Merlin Systems</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2022 NVIDIA Corporation. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>
</pre></div>
</div>
</div>
</div>
<img alt="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" src="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" />
<div class="tex2jax_ignore mathjax_ignore section" id="serving-ranking-models-with-merlin-systems">
<h1>Serving Ranking Models With Merlin Systems<a class="headerlink" href="#serving-ranking-models-with-merlin-systems" title="Permalink to this headline"></a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>NVIDIA Merlin is an open source framework that accelerates and scales end-to-end recommender system pipelines. The Merlin framework is broken up into several sub components, these include: Merlin-Core, Merlin-Models, NVTabular and Merlin-Systems. Merlin Systems will be the focus of this example.</p>
<p>The purpose of the Merlin Systems library is to make it easy for Merlin users to quickly deploy their recommender systems from development to <a class="reference external" href="https://github.com/triton-inference-server/server">Triton Inference Server</a>. We extended the same user-friendly API users are accustomed to in NVTabular and leveraged it to accommodate deploying your recommender system components to Triton.</p>
<p>There are some things we need ensure before we continue with this Notebook. Please ensure you have a working workflow and model stored in an accessible location. As previously mentioned, Merlin Systems will take the data preprocessing workflow defined in NVTabular and load that into Triton as a model. Subsequently it will do the same for the trained model. Lets take a closer look in the rest of this notebook at how Merlin systems makes deploying to Triton simple and effortless.</p>
<p>Be sure to check the other components of the Merlin framework, they can help you.</p>
<div class="section" id="learning-objectives">
<h3>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this headline"></a></h3>
<p>In this notebook, we learn how to deploy a NVTabular Workflow and a trained Tensorflow model from Merlin Models to Triton.</p>
<ul class="simple">
<li><p>Load NVTabular Workflow</p></li>
<li><p>Load Pre-trained Merlin Models model</p></li>
<li><p>Create Ensemble Graph</p></li>
<li><p>Export Ensemble Graph</p></li>
<li><p>Run Tritonserver</p></li>
<li><p>Send Request to Tritonserver</p></li>
</ul>
</div>
<div class="section" id="dataset">
<h3>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline"></a></h3>
<p>In this notebook, we will be leveraging the <a class="reference external" href="https://tianchi.aliyun.com/dataset/dataDetail?dataId=408#1">Alibaba dataset</a>. It is important to note that the steps will take in this notebook are generalized and can be applied to any set of workflow and models. To see how the data is transformed please check the <a class="reference external" href="https://github.com/NVIDIA-Merlin/NVTabular">NVTabular</a> example for the Alibaba dataset. And to see how an Alibaba dataset trained model is created check the <a class="reference external" href="https://github.com/NVIDIA-Merlin/models">merlin-models</a></p>
</div>
<div class="section" id="tools">
<h3>Tools<a class="headerlink" href="#tools" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>NVTabular</p></li>
<li><p>Merlin Models</p></li>
<li><p>Merlin Systems</p></li>
<li><p>Triton Inference Server</p></li>
</ul>
</div>
</div>
<div class="section" id="install-required-libraries">
<h2>Install Required Libraries<a class="headerlink" href="#install-required-libraries" title="Permalink to this headline"></a></h2>
<p>Install TensorFlow so we can read the saved model from disk.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install tensorflow-gpu &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-an-nvtabular-workflow">
<h2>Load an NVTabular Workflow<a class="headerlink" href="#load-an-nvtabular-workflow" title="Permalink to this headline"></a></h2>
<p>First, we load the <code class="docutils literal notranslate"><span class="pre">nvtabular.Workflow</span></code> that we created in with this <a class="reference external" href="https://github.com/NVIDIA-Merlin/models/blob/main/examples/04-Exporting-ranking-models.ipynb">example</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_GPU_ALLOCATOR&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;cuda_malloc_async&quot;</span>
<span class="kn">from</span> <span class="nn">nvtabular.workflow</span> <span class="kn">import</span> <span class="n">Workflow</span>

<span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INPUT_FOLDER&quot;</span><span class="p">,</span> <span class="s2">&quot;/workspace/data/&quot;</span><span class="p">)</span>

<span class="n">workflow_stored_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;workflow&quot;</span><span class="p">)</span>

<span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">workflow_stored_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After we load the workflow, we remove the label columns from it’s inputs. This removes all columns with the <code class="docutils literal notranslate"><span class="pre">TARGET</span></code> tag from the workflow. We do this because we need to set the workflow to only  require the features needed to predict, not train, when creating an inference pipeline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.schema.tags</span> <span class="kn">import</span> <span class="n">Tags</span>

<span class="n">label_columns</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">select_by_tag</span><span class="p">(</span><span class="n">Tags</span><span class="o">.</span><span class="n">TARGET</span><span class="p">)</span><span class="o">.</span><span class="n">column_names</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">remove_inputs</span><span class="p">(</span><span class="n">label_columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nvtabular.workflow.workflow.Workflow at 0x7fc87e747130&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-the-tensorflow-model">
<h2>Load the Tensorflow Model<a class="headerlink" href="#load-the-tensorflow-model" title="Permalink to this headline"></a></h2>
<p>After loading the workflow, we load the model. This model was trained with the output of the workflow from the <a class="reference external" href="https://github.com/NVIDIA-Merlin/models/blob/main/examples/04-Exporting-ranking-models.ipynb">Exporting Ranking Models</a> example from Merlin Models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;dlrm&quot;</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">tf_model_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-04-14 18:43:13.614628: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-04-14 18:43:18.551263: I tensorflow/core/common_runtime/gpu/gpu_process_state.cc:214] Using CUDA malloc Async allocator for GPU: 0
2022-04-14 18:43:18.551460: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 11562 MB memory:  -&gt; device: 0, name: Tesla V100-DGXS-16GB, pci bus id: 0000:07:00.0, compute capability: 7.0
2022-04-14 18:43:18.552259: I tensorflow/core/common_runtime/gpu/gpu_process_state.cc:214] Using CUDA malloc Async allocator for GPU: 1
2022-04-14 18:43:18.552326: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:1 with 12539 MB memory:  -&gt; device: 1, name: Tesla V100-DGXS-16GB, pci bus id: 0000:08:00.0, compute capability: 7.0
2022-04-14 18:43:18.553045: I tensorflow/core/common_runtime/gpu/gpu_process_state.cc:214] Using CUDA malloc Async allocator for GPU: 2
2022-04-14 18:43:18.553106: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:2 with 12719 MB memory:  -&gt; device: 2, name: Tesla V100-DGXS-16GB, pci bus id: 0000:0e:00.0, compute capability: 7.0
2022-04-14 18:43:18.553827: I tensorflow/core/common_runtime/gpu/gpu_process_state.cc:214] Using CUDA malloc Async allocator for GPU: 3
2022-04-14 18:43:18.553886: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:3 with 12719 MB memory:  -&gt; device: 3, name: Tesla V100-DGXS-16GB, pci bus id: 0000:0f:00.0, compute capability: 7.0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-the-ensemble-graph">
<h2>Create the Ensemble Graph<a class="headerlink" href="#create-the-ensemble-graph" title="Permalink to this headline"></a></h2>
<p>After we have both the model and the workflow loaded, we can create the ensemble graph. You create the graph. The goal is to illustrate the path of data through your full system. In this example we only serve a workflow with a model, but you can add other components that help you meet your business logic requirements.</p>
<p>Because this example has two components—a model and a workflow—we require two operators. These operators, also known as inference operators, are meant to abstract away all the “hard parts” of loading a specific component, such as a workflow or model, into Triton Inference Server.</p>
<p>The following code block shows how to use two inference operators:</p>
<dl>
    <dt><code>TransformWorkflow</code></dt>
    <dd>This operator ensures that the workflow is correctly saved and packaged with the required config so the server will know how to load it.</dd>
    <dt><code>PredictTensorflow</code></dt>
    <dd>This operator will do something similar with the model, loaded before.</dd>
</dl>
<p>Let’s give it a try.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.workflow</span> <span class="kn">import</span> <span class="n">TransformWorkflow</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.tensorflow</span> <span class="kn">import</span> <span class="n">PredictTensorflow</span>

<span class="n">serving_operators</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span> <span class="o">&gt;&gt;</span> <span class="n">TransformWorkflow</span><span class="p">(</span><span class="n">workflow</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PredictTensorflow</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="export-graph-as-ensemble">
<h2>Export Graph as Ensemble<a class="headerlink" href="#export-graph-as-ensemble" title="Permalink to this headline"></a></h2>
<p>The last step is to create the ensemble artifacts that Triton Inference Server can consume.
To make these artifacts, we import the <code class="docutils literal notranslate"><span class="pre">Ensemble</span></code> class.
The class is responsible for interpreting the graph and exporting the correct files for the server.</p>
<p>After you run the following cell, you’ll see that we create a <code class="docutils literal notranslate"><span class="pre">ColumnSchema</span></code> for the expected inputs to the workflow.
The workflow is a <code class="docutils literal notranslate"><span class="pre">Schema</span></code>.</p>
<p>When you are creating an <code class="docutils literal notranslate"><span class="pre">Ensemble</span></code> object you supply the graph and a schema representing the starting input of the graph. the inputs to the ensemble graph are the inputs to the first operator of your graph.</p>
<p>After you have created the <code class="docutils literal notranslate"><span class="pre">Ensemble</span></code> you export the graph, supplying an export path for the <code class="docutils literal notranslate"><span class="pre">Ensemble.export</span></code> function.</p>
<p>This returns an ensemble config which represents the entire inference pipeline and a list of node-specific configs.</p>
<p>Let’s take a look below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;name&#39;: &#39;user_id&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;item_id&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;item_category&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;item_shop&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;item_brand&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_shops&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_profile&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_group&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_gender&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_age&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_consumption_2&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_is_occupied&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_geography&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_intentions&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_brands&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}, {&#39;name&#39;: &#39;user_categories&#39;, &#39;tags&#39;: set(), &#39;properties&#39;: {}, &#39;dtype&#39;: dtype(&#39;int32&#39;), &#39;is_list&#39;: False, &#39;is_ragged&#39;: False}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.systems.dag.ensemble</span> <span class="kn">import</span> <span class="n">Ensemble</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">Ensemble</span><span class="p">(</span><span class="n">serving_operators</span><span class="p">,</span> <span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="p">)</span>

<span class="n">export_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;ensemble&quot;</span><span class="p">)</span>

<span class="n">ens_conf</span><span class="p">,</span> <span class="n">node_confs</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">export_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-04-14 18:43:24.644857: W tensorflow/python/util/util.cc:368] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.
WARNING:absl:Found untraced functions such as restored_function_body, restored_function_body, restored_function_body, restored_function_body, click/binary_classification_task/output_layer_layer_call_fn while saving (showing 5 of 48). These functions will not be directly callable after loading.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: /workspace/data/ensemble/1_predicttensorflow/1/model.savedmodel/assets
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: /workspace/data/ensemble/1_predicttensorflow/1/model.savedmodel/assets
</pre></div>
</div>
</div>
</div>
<p>Display the path to the directory with the ensemble.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">export_path</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/workspace/data/ensemble&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="verification-of-ensemble-artifacts">
<h2>Verification of Ensemble Artifacts<a class="headerlink" href="#verification-of-ensemble-artifacts" title="Permalink to this headline"></a></h2>
<p>After we export the ensemble, we can check the export path for the graph’s artifacts. The directory structure represents an ordering number followed by an operator identifier such as <code class="docutils literal notranslate"><span class="pre">1_transformworkflow</span></code>, <code class="docutils literal notranslate"><span class="pre">2_predicttensorflow</span></code>, and so on.</p>
<p>Inside each of those directories, the <code class="docutils literal notranslate"><span class="pre">export</span></code> method writes a <code class="docutils literal notranslate"><span class="pre">config.pbtxt</span></code> file and a directory with a number. The number indicates the version and begins at 1. The artifacts for each operator are found inside the <code class="docutils literal notranslate"><span class="pre">version</span></code> folder. These artifacts vary depending on the operator in use.</p>
<p>Install the <code class="docutils literal notranslate"><span class="pre">tree</span></code> executable so we can view some of the directory contents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>apt update &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="o">!</span>apt install tree &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="o">!</span>tree -L <span class="m">2</span> <span class="o">{</span>export_path<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Blue">/workspace/data/ensemble</span>
├── <span class=" -Color -Color-Bold -Color-Bold-Blue">0_transformworkflow</span>
│   ├── <span class=" -Color -Color-Bold -Color-Bold-Blue">1</span>
│   └── config.pbtxt
├── <span class=" -Color -Color-Bold -Color-Bold-Blue">1_predicttensorflow</span>
│   ├── <span class=" -Color -Color-Bold -Color-Bold-Blue">1</span>
│   └── config.pbtxt
└── <span class=" -Color -Color-Bold -Color-Bold-Blue">ensemble_model</span>
    ├── <span class=" -Color -Color-Bold -Color-Bold-Blue">1</span>
    └── config.pbtxt

6 directories, 3 files
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="starting-triton-inference-server">
<h2>Starting Triton Inference Server<a class="headerlink" href="#starting-triton-inference-server" title="Permalink to this headline"></a></h2>
<p>After we export the ensemble, we are ready to start the Triton Inference Server. The server is installed in all the Merlin inference containers.  If you are not using one of our containers, then ensure it is installed in your environment. For more information, see the Triton Inference Server <a class="reference external" href="https://github.com/triton-inference-server/server/blob/r22.03/README.md#documentation">documentation</a>.</p>
<p>You can start the server by running the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>tritonserver --model-repository<span class="o">=</span>/workspace/data/ensemble --backend-config<span class="o">=</span>tensorflow,version<span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">--model-repository</span></code> argument, specify the same value as the <code class="docutils literal notranslate"><span class="pre">export_path</span></code> that you specified previously in the <code class="docutils literal notranslate"><span class="pre">ensemble.export</span></code> method.</p>
<p>After you run the <code class="docutils literal notranslate"><span class="pre">tritonserver</span></code> command, wait until your terminal shows messages like the following example:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>I0414 <span class="m">18</span>:29:50.741833 <span class="m">4067</span> grpc_server.cc:4421<span class="o">]</span> Started GRPCInferenceService at <span class="m">0</span>.0.0.0:8001
I0414 <span class="m">18</span>:29:50.742197 <span class="m">4067</span> http_server.cc:3113<span class="o">]</span> Started HTTPService at <span class="m">0</span>.0.0.0:8000
I0414 <span class="m">18</span>:29:50.783470 <span class="m">4067</span> http_server.cc:178<span class="o">]</span> Started Metrics Service at <span class="m">0</span>.0.0.0:8002
</pre></div>
</div>
</div>
<div class="section" id="retrieving-recommendations-from-triton-inference-server">
<h2>Retrieving Recommendations from Triton Inference Server<a class="headerlink" href="#retrieving-recommendations-from-triton-inference-server" title="Permalink to this headline"></a></h2>
<p>Now that our server is running, we can send requests to it. This request is composed of values that correspond to the request schema that was created when we exported the ensemble graph.</p>
<p>In the code below we create a request to send to triton and send it. We will then analyze the response, to show the full experience.</p>
<p>First we need to ensure that we have a client connected to the server that we started. To do this, we use on the Triton HTTP client library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tritonclient.http</span> <span class="k">as</span> <span class="nn">client</span>

<span class="c1"># Create a triton client</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">triton_client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">InferenceServerClient</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;localhost:8000&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;client created.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;channel creation failed: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>client created.
</pre></div>
</div>
</div>
</div>
<p>After we create the client and verified it is connected to the server instance, we can communicate with the server and ensure all the models are loaded correctly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ensure triton is in a good state</span>
<span class="n">triton_client</span><span class="o">.</span><span class="n">is_server_live</span><span class="p">()</span>
<span class="n">triton_client</span><span class="o">.</span><span class="n">get_model_repository_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GET /v2/health/live, headers None
&lt;HTTPSocketPoolResponse status=200 headers={&#39;content-length&#39;: &#39;0&#39;, &#39;content-type&#39;: &#39;text/plain&#39;}&gt;
POST /v2/repository/index, headers None

&lt;HTTPSocketPoolResponse status=200 headers={&#39;content-type&#39;: &#39;application/json&#39;, &#39;content-length&#39;: &#39;179&#39;}&gt;
bytearray(b&#39;[{&quot;name&quot;:&quot;0_transformworkflow&quot;,&quot;version&quot;:&quot;1&quot;,&quot;state&quot;:&quot;READY&quot;},{&quot;name&quot;:&quot;1_predicttensorflow&quot;,&quot;version&quot;:&quot;1&quot;,&quot;state&quot;:&quot;READY&quot;},{&quot;name&quot;:&quot;ensemble_model&quot;,&quot;version&quot;:&quot;1&quot;,&quot;state&quot;:&quot;READY&quot;}]&#39;)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;name&#39;: &#39;0_transformworkflow&#39;, &#39;version&#39;: &#39;1&#39;, &#39;state&#39;: &#39;READY&#39;},
 {&#39;name&#39;: &#39;1_predicttensorflow&#39;, &#39;version&#39;: &#39;1&#39;, &#39;state&#39;: &#39;READY&#39;},
 {&#39;name&#39;: &#39;ensemble_model&#39;, &#39;version&#39;: &#39;1&#39;, &#39;state&#39;: &#39;READY&#39;}]
</pre></div>
</div>
</div>
</div>
<p>After verifying the models are correctly loaded by the server, we use some original validation data and send it as an inference request to the server.</p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">df_lib</span></code> object is <code class="docutils literal notranslate"><span class="pre">cudf</span></code> if a GPU is available and <code class="docutils literal notranslate"><span class="pre">pandas</span></code> otherwise.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.core.dispatch</span> <span class="kn">import</span> <span class="n">get_lib</span>

<span class="n">df_lib</span> <span class="o">=</span> <span class="n">get_lib</span><span class="p">()</span>

<span class="n">original_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INPUT_FOLDER&quot;</span><span class="p">,</span> <span class="s2">&quot;/workspace/data/&quot;</span><span class="p">)</span>

<span class="c1"># read in data for request</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">df_lib</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_data_path</span><span class="p">,</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;part.0.parquet&quot;</span><span class="p">),</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span>
<span class="p">)</span>
<span class="n">batch</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>item_id</th>
      <th>item_category</th>
      <th>item_shop</th>
      <th>item_brand</th>
      <th>user_shops</th>
      <th>user_profile</th>
      <th>user_group</th>
      <th>user_gender</th>
      <th>user_age</th>
      <th>user_consumption_2</th>
      <th>user_is_occupied</th>
      <th>user_geography</th>
      <th>user_intentions</th>
      <th>user_brands</th>
      <th>user_categories</th>
    </tr>
    <tr>
      <th>__null_dask_index__</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>700000</th>
      <td>7</td>
      <td>6</td>
      <td>21</td>
      <td>1447</td>
      <td>499</td>
      <td>272</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>79</td>
      <td>135</td>
      <td>15</td>
    </tr>
    <tr>
      <th>700001</th>
      <td>9</td>
      <td>75</td>
      <td>304</td>
      <td>21404</td>
      <td>7371</td>
      <td>362</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>105</td>
      <td>180</td>
      <td>19</td>
    </tr>
    <tr>
      <th>700002</th>
      <td>14</td>
      <td>10</td>
      <td>37</td>
      <td>2604</td>
      <td>897</td>
      <td>588</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>170</td>
      <td>292</td>
      <td>31</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>After we isolate our <code class="docutils literal notranslate"><span class="pre">batch</span></code>, we convert the dataframe representation into inputs for Triton. We also declare the outputs that we expect to receive from the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.systems.triton</span> <span class="kn">import</span> <span class="n">convert_df_to_triton_input</span>
<span class="kn">import</span> <span class="nn">tritonclient.grpc</span> <span class="k">as</span> <span class="nn">grpcclient</span>
<span class="c1"># create inputs and outputs</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">convert_df_to_triton_input</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">grpcclient</span><span class="o">.</span><span class="n">InferInput</span><span class="p">)</span>

<span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">grpcclient</span><span class="o">.</span><span class="n">InferRequestedOutput</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_names</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now that our <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">outputs</span></code> are created, we can use the <code class="docutils literal notranslate"><span class="pre">triton_client</span></code> that we created earlier to send the inference request.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># send request to tritonserver</span>
<span class="k">with</span> <span class="n">grpcclient</span><span class="o">.</span><span class="n">InferenceServerClient</span><span class="p">(</span><span class="s2">&quot;localhost:8001&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="s2">&quot;ensemble_model&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When the server completes the inference request, it returns a response. This response is parsed to get the desired predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># access individual response columns to get values back.</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">response</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>output_1 [[0.50345296]
 [0.50178283]
 [0.5061866 ]] (3, 1)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline"></a></h2>
<p>This sample notebook started with an exported DLRM model and workflow.  We saw how to create an ensemble graph,
verify the ensemble artifacts in the file system, and then put the ensemble into production with
Triton Inference Server.  Finally, we sent a simple inference request to the server and printed the response.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Merlin Systems Example Notebook" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api.html" class="btn btn-neutral float-right" title="API Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v0.2.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v0.1.0/index.html">v0.1.0</a></dd>
      <dd><a href="Serving-Ranking-Models-With-Merlin-Systems.html">v0.2.0</a></dd>
      <dd><a href="../../v0.3.0/index.html">v0.3.0</a></dd>
      <dd><a href="../../v0.4.0/index.html">v0.4.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../main/index.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>